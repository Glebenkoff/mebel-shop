<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f9f9f9;
            padding: 20px;
            margin: 0;
        }
        .form-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .btn {
            background: #e74c3c;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
        }
        .btn:hover {
            background: #c0392b;
        }
    </style>
</head>
<body>

<div class="form-container">
    <h1>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h1>

    <form method="post">
        {% csrf_token %}

        <!-- –ò–º—è -->
        <div class="form-group">
            <label for="id_name">–ò–º—è:</label>
            <input type="text" name="name" id="id_name" class="form-control" required>
        </div>

        <!-- Email -->
        <div class="form-group">
            <label for="id_email">Email:</label>
            <input type="email" name="email" id="id_email" class="form-control" required>
        </div>

        <!-- –¢–µ–ª–µ—Ñ–æ–Ω -->
        <div class="form-group">
            <label for="id_phone">–¢–µ–ª–µ—Ñ–æ–Ω:</label>
            <input type="tel" id="id_phone" name="phone" class="form-control" placeholder="+7 (___) ___-__-__" required>
        </div>

        <!-- –ü–æ–ª–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–∞ -->
        <div class="form-group">
            <label for="id_address_search">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:</label>
            <input type="text" id="id_address_search" class="form-control" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å..." autocomplete="off">
            <small>–í—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫</small>
        </div>

        <!-- –†–∞–∑–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è -->
        <div class="form-group">
            <label for="id_region">–û–±–ª–∞—Å—Ç—å / —Ä–µ–≥–∏–æ–Ω:</label>
            <input type="text" id="id_region" name="region" class="form-control" required>
        </div>

        <div class="form-group">
            <label for="id_city">–ì–æ—Ä–æ–¥:</label>
            <input type="text" id="id_city" name="city" class="form-control" required>
        </div>

        <div class="form-group">
            <label for="id_street">–£–ª–∏—Ü–∞:</label>
            <input type="text" id="id_street" name="street" class="form-control" required>
        </div>

        <div class="form-group">
            <label for="id_house">–î–æ–º:</label>
            <input type="text" id="id_house" name="house" class="form-control" required>
        </div>

        <div class="form-group">
            <label for="id_block">–ö–æ—Ä–ø—É—Å / —Å—Ç—Ä–æ–µ–Ω–∏–µ:</label>
            <input type="text" id="id_block" name="block" class="form-control">
        </div>

        <div class="form-group">
            <label for="id_apartment">–ö–≤–∞—Ä—Ç–∏—Ä–∞ / –æ—Ñ–∏—Å:</label>
            <input type="text" id="id_apartment" name="apartment" class="form-control">
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
        <button type="submit" class="btn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </form>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º DaData CSS –∏ JS -->
<link href="https://cdn.jsdelivr.net/npm/@dadata/suggestions@25.4.1/dist/suggestions.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/@dadata/suggestions@25.4.1/dist/suggestions.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    console.log("‚úÖ DOM –∑–∞–≥—Ä—É–∂–µ–Ω");

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ Dadata
    if (typeof Dadata === 'undefined') {
        console.error("‚ùå DaData –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞.");
        return;
    }

    const searchInput = document.getElementById("id_address_search");
    if (!searchInput) {
        console.error("‚ùå –≠–ª–µ–º–µ–Ω—Ç id_address_search –Ω–µ –Ω–∞–π–¥–µ–Ω");
        return;
    }

    console.log("‚úÖ –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–∞ –Ω–∞–π–¥–µ–Ω–æ");

    try {
        Dadata.createSuggestions(searchInput, {
            token: "8b39afafcf745093ea4dfc5c6902a5dab4d6a573",
            type: "ADDRESS",
            constraints: { locations: { country: "–†–æ—Å—Å–∏—è" } },
            onSelect: function(suggestion) {
                console.log("‚úÖ –í—ã–±—Ä–∞–Ω –∞–¥—Ä–µ—Å:", suggestion);
                const data = suggestion.data;

                const setVal = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.value = value || "";
                        console.log(`üìå –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ ${id}:`, value);
                    } else {
                        console.warn(`‚ö†Ô∏è –≠–ª–µ–º–µ–Ω—Ç ${id} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                    }
                };

                setVal("id_region", data.region_with_type || data.region || "");
                setVal("id_city", data.city || data.settlement || data.locality || "");
                setVal("id_street", data.street_with_type || data.street || "");
                setVal("id_house", data.house || "");
                setVal("id_block", data.block || "");
                // setVal("id_apartment", ""); // –Ω–µ –æ—á–∏—â–∞–µ–º ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Å–∞–º

                // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                alert("–ê–¥—Ä–µ—Å —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω!");
            }
        });

        console.log("‚úÖ DaData –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
    } catch (err) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ DaData:", err);
    }

    // === –ú–∞—Å–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ===
    const phoneInput = document.getElementById('id_phone');
    if (phoneInput) {
        phoneInput.addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, '');

            if (value.startsWith('8')) value = value.slice(1);
            if (value.startsWith('7')) value = value.slice(1);

            value = value.slice(0, 10);
            let formatted = '+7';
            if (value) {
                formatted += ' (';
                if (value.length >= 3) {
                    formatted += value.slice(0, 3) + ') ';
                    if (value.length >= 6) {
                        formatted += value.slice(3, 6) + '-';
                        if (value.length >= 8) {
                            formatted += value.slice(6, 8) + '-' + value.slice(8, 10);
                        } else {
                            formatted += value.slice(6);
                        }
                    } else {
                        formatted += value.slice(3);
                    }
                } else {
                    formatted += value;
                }
            }
            e.target.value = formatted;
        });
    }
});
</script>

</body>
</html>